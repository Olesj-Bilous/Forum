@using Data.Entities
@model NewViewModel
@{
    ViewBag.Title = "New post";
    ViewBag.NewView = true;
    ViewBag.PostView = false;
    ViewBag.TopicsView = false;
}

<form asp-action="@(Model.Source is null ? "NewPost" : "NewReply")" method="post">
    <input type="hidden" asp-for="TopicId" value="@Model.TopicId"/>
    <input type="hidden" asp-for="SourceId" value="@Model.SourceId"/>
    @{
        // origin is topic if source message is null, else origin is message
        var originIsTopic = Model.Source is null;

        // even if origin is reply, we still want to wrap everything as a post
        <div class=@(originIsTopic ? "topic" : "post")>
            @if (originIsTopic)
            {
                // original topic
                ViewBag.Topic = Model.Topic;
                <partial name="_TopicHeader" view-data="ViewData"/>
            }
            else
            {
                // original post
                ViewBag.Message = Model.Source is Post ? Model.Source : ((Reply)Model.Source).Post;
                <partial name="_Message" view-data="ViewData"/>
            }
            @* 
                new post inside topic-body 
                or
                new reply inside post-footer
            *@
            <div class=@(originIsTopic ? "topic-body" : "post-footer")>
                
                @if (Model.Source is Reply)
                {
                    // original reply 
                    ViewBag.Message = Model.Source;
                    <div class="reply mb-1">
                        <partial name="_Message" view-data="ViewData"/>
                    </div>
                }

                @* new message *@
                <div class="@(originIsTopic ? "post" : "reply") mb-1"
                     style=@(Model.Source is Reply ? "margin-left:8px" : "")>
                    @if (originIsTopic)
                    {
                        // new post title
                        <div class="msg-label">
                            <input class="form-control" asp-for="Title" placeholder="A title" />
                        </div>
                    }
                    
                    @* new message text *@
                    <div class="msg-body">
                        <textarea class="form-control" asp-for="Text" rows="7" placeholder=@(originIsTopic ? "Your idea" : "Your reply")></textarea>
                    </div>
                </div>
            </div>
        </div>
    }

    <div class="mt-3 m-1 ps-2">
        @* post button *@
        <input class="btn text-large" type="submit" value="Post" />

        @* cancel button *@
        <a class="btn text-large ms-2"
            asp-action="@(originIsTopic ? "Topic" : "Post")"
            asp-route-id="@(originIsTopic
                ? Model.TopicId
                : Model.Source is Post ? Model.SourceId : ((Reply)Model.Source).PostId )">
            Cancel
        </a>
    </div>
</form>